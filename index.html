<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Biblioteca de Games</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate-900 */
        }
        /* Estilos personalizados para o app (n√£o-Tailwind) */
        .game-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .game-card:hover {
            transform: translateY(-2px);
        }
        .rating-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease-out;
        }
        .container-lg {
            max-width: 1024px;
        }
        /* Estiliza√ß√£o b√°sica para input[type="date"] no tema escuro */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Torna o √≠cone do calend√°rio branco */
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="container-lg mx-auto">
        <header class="text-center mb-8">
            <!-- MASCOTE ATUALIZADO: Joystick (üïπÔ∏è) -->
            <h1 class="text-4xl font-extrabold text-white mb-2">üïπÔ∏è Biblioteca de Games</h1>
            <p id="user-id-display" class="text-sm text-slate-400">ID do Usu√°rio: Carregando...</p>
            <p class="text-lg text-slate-300">Organize, avalie e documente seus jogos.</p>
        </header>

        <!-- Formul√°rio para Adicionar/Editar Jogo -->
        <div id="game-form-container" class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl mb-8">
            <h2 id="form-title" class="text-2xl font-semibold text-white mb-4">Adicionar Novo Jogo</h2>
            <form id="game-form" class="space-y-4">
                <input type="hidden" id="game-id">

                <!-- Nome do Jogo -->
                <div>
                    <label for="name" class="block text-sm font-medium text-slate-300">Nome do Jogo</label>
                    <input type="text" id="name" required class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- URL da Capa e Busca -->
                <div>
                    <label for="coverUrl" class="block text-sm font-medium text-slate-300">URL da Capa do Jogo (Opcional)</label>
                    <div class="flex space-x-2 mt-1">
                        <input type="url" id="coverUrl" class="block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: https://caminho.para/sua_capa.jpg">
                        <button type="button" id="search-cover-btn" class="flex-shrink-0 px-4 py-2 bg-pink-600 text-white font-medium rounded-lg hover:bg-pink-700 transition-colors">
                            Buscar Capa
                        </button>
                    </div>
                    <p id="search-tip" class="text-xs text-slate-500 mt-1">Use o bot√£o de busca para pesquisar a capa no Google. Copie o endere√ßo da imagem e cole acima.</p>
                </div>
                
                <!-- NOVOS CAMPOS: Datas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Data de In√≠cio -->
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-slate-300">Data de In√≠cio (Opcional)</label>
                        <input type="date" id="startDate" class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Data de Finaliza√ß√£o -->
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-slate-300">Data de Finaliza√ß√£o (Opcional)</label>
                        <input type="date" id="endDate" class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Console/Plataforma (OP√á√ïES EXPANDIDAS) -->
                    <div>
                        <label for="console" class="block text-sm font-medium text-slate-300">Console/Plataforma</label>
                        <select id="console" required class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Selecione</option>
                            <optgroup label="Atual/Moderno">
                                <option value="PC">PC</option>
                                <option value="PS5">PlayStation 5</option>
                                <option value="PS4">PlayStation 4</option>
                                <option value="XSX">Xbox Series X|S</option>
                                <option value="XB1">Xbox One</option>
                                <option value="Switch">Nintendo Switch</option>
                                <option value="Mobile">Mobile</option>
                            </optgroup>
                            <optgroup label="Cl√°ssico/Retro">
                                <option value="PS3">PlayStation 3</option>
                                <option value="PS2">PlayStation 2</option>
                                <option value="PS1">PlayStation 1 (PSX)</option>
                                <option value="XBOX360">Xbox 360</option>
                                <option value="N64">Nintendo 64</option>
                                <option value="SNES">Super Nintendo (SNES)</option>
                                <option value="NES">Nintendo (NES)</option>
                                <option value="MD">Mega Drive</option>
                                <option value="DC">Dreamcast</option>
                                <option value="GC">GameCube</option>
                                <option value="Wii">Wii</option>
                                <option value="GB">Game Boy / GBA</option>
                                <option value="PSP">PSP / Vita</option>
                            </optgroup>
                            <option value="Outro">Outro/Customizado</option>
                        </select>
                    </div>

                    <!-- Categoria -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-slate-300">Categoria</label>
                        <select id="category" required class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Desejo Jogar">Desejo Jogar</option>
                            <option value="Jogando">Jogando</option>
                            <option value="Zerado">Zerado</option>
                            <option value="Abandonado">Abandonado</option>
                        </select>
                    </div>

                    <!-- Nota (1-10) -->
                    <div>
                        <label for="rating" class="block text-sm font-medium text-slate-300">Nota (0-10)</label>
                        <input type="range" id="rating" min="0" max="10" step="1" value="5" class="mt-1 block w-full h-8 cursor-pointer appearance-none bg-slate-700 rounded-lg">
                        <p id="rating-value" class="text-center text-indigo-400 font-bold mt-1 text-lg">5</p>
                    </div>
                </div>
                
                <!-- Observa√ß√µes -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-slate-300">Observa√ß√µes</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancel-edit-btn" class="hidden px-4 py-2 bg-slate-600 text-white font-medium rounded-lg hover:bg-slate-500 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" id="save-btn" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/50">
                        Salvar Jogo
                    </button>
                </div>
            </form>
        </div>

        <!-- NOVO BLOCO: Controles de Filtros e Ordena√ß√£o -->
        <div class="bg-slate-800 p-4 rounded-xl shadow-2xl mb-6 flex flex-col md:flex-row md:items-center justify-between space-y-4 md:space-y-0">
            
            <!-- Filtro por Categoria -->
            <div class="flex flex-wrap items-center">
                <label class="text-slate-300 text-sm font-medium mr-3 mb-2 md:mb-0 w-full md:w-auto">Filtrar por Categoria:</label>
                <div class="inline-flex rounded-lg shadow-sm w-full md:w-auto" role="group">
                    <button type="button" data-filter="Todos" class="filter-btn px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-l-lg border border-indigo-700 hover:bg-indigo-700 transition-colors">
                        Todos
                    </button>
                    <button type="button" data-filter="Zerado" class="filter-btn px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 border-t border-b border-slate-600 hover:bg-slate-600 transition-colors">
                        Zerado
                    </button>
                    <button type="button" data-filter="Jogando" class="filter-btn px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 border-t border-b border-slate-600 hover:bg-slate-600 transition-colors">
                        Jogando
                    </button>
                    <button type="button" data-filter="Desejo Jogar" class="filter-btn px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 rounded-r-lg border border-slate-600 hover:bg-slate-600 transition-colors">
                        Desejo Jogar
                    </button>
                </div>
            </div>

            <!-- Ordena√ß√£o por Nota -->
            <div class="flex flex-wrap items-center">
                <label class="text-slate-300 text-sm font-medium mr-3 mb-2 md:mb-0 w-full md:w-auto">Ordenar por Nota:</label>
                <div class="inline-flex rounded-lg shadow-sm w-full md:w-auto" role="group">
                    <button type="button" data-sort="ratingDesc" class="sort-btn px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-l-lg border border-indigo-700 hover:bg-indigo-700 transition-colors">
                        Maior Nota
                    </button>
                    <button type="button" data-sort="ratingAsc" class="sort-btn px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 rounded-r-lg border border-slate-600 hover:bg-slate-600 transition-colors">
                        Menor Nota
                    </button>
                </div>
            </div>
        </div>
        <!-- Fim Controles -->

        <!-- Lista de Jogos -->
        <div class="bg-slate-900 p-4 md:p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold text-white mb-4">Meus Jogos</h2>
            <div id="game-list" class="space-y-4">
                <!-- Jogos ser√£o injetados aqui -->
                <p id="loading-message" class="text-slate-400 text-center py-8">Carregando sua biblioteca...</p>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o (customizado) -->
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-slate-800 rounded-xl p-6 w-11/12 max-w-sm shadow-2xl border border-red-600/50">
                <h3 class="text-xl font-bold text-red-400 mb-4">Confirmar Exclus√£o</h3>
                <p class="text-slate-300 mb-6">Tem certeza de que deseja excluir o jogo "<span id="modal-game-name" class="font-semibold text-white"></span>"? Esta a√ß√£o n√£o pode ser desfeita.</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500">Cancelar</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Excluir</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports (Module) -->
    <script type="module">
        // Importa apenas as fun√ß√µes necess√°rias (se a inicializa√ß√£o for chamada)
        let initializeApp, getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence, setLogLevel;

        // Tenta importar as depend√™ncias do Firebase.
        try {
            const firebaseAppModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            initializeApp = firebaseAppModule.initializeApp;

            const firestoreModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            getFirestore = firestoreModule.getFirestore;
            collection = firestoreModule.collection;
            addDoc = firestoreModule.addDoc;
            doc = firestoreModule.doc;
            updateDoc = firestoreModule.updateDoc;
            deleteDoc = firestoreModule.deleteDoc;
            onSnapshot = firestoreModule.onSnapshot;
            query = firestoreModule.query;
            orderBy = firestoreModule.orderBy;
            serverTimestamp = firestoreModule.serverTimestamp;
            setLogLevel = firestoreModule.setLogLevel;

            const authModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            getAuth = authModule.getAuth;
            signInAnonymously = authModule.signInAnonymously;
            signInWithCustomToken = authModule.signInWithCustomToken;
            onAuthStateChanged = authModule.onAuthStateChanged;
            setPersistence = authModule.setPersistence;
            browserLocalPersistence = authModule.browserLocalPersistence;

            // setLogLevel('Debug'); // Deixamos o debug desativado para evitar polui√ß√£o no console no modo local
        } catch (e) {
            console.warn("Firebase imports skipped. Running in Local/Offline mode.");
        }


        // Vari√°veis globais do ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Configura√ß√µes e detec√ß√£o de modo local
        const DUMMY_API_KEY = "dummy-key";
        const defaultFirebaseConfig = {
            projectId: "local-dev-project", 
            apiKey: DUMMY_API_KEY, 
            // O restante das chaves √© irrelevante no modo dev local, pois n√£o faremos a conex√£o.
        };
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' && __firebase_config ? __firebase_config : JSON.stringify(defaultFirebaseConfig));
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Vari√°vel de controle: se a chave API for a dummy, estamos no modo de desenvolvimento local.
        const isLocalDevMode = firebaseConfig.apiKey === DUMMY_API_KEY;


        // Vari√°veis de Firebase (ser√£o nulas no modo local)
        let app = null;
        let db = null;
        let auth = null;
        
        // Inicializa√ß√£o Condicional
        if (!isLocalDevMode) {
            // MODO PRODU√á√ÉO (Canvas/Ambiente com chaves reais): Inicializa o Firebase
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Falha ao inicializar o Firebase em modo PROD:", error);
            }
        }
        
        
        // Elementos do DOM
        const gameForm = document.getElementById('game-form');
        const gameList = document.getElementById('game-list');
        const formTitle = document.getElementById('form-title');
        const gameIdInput = document.getElementById('game-id');
        const nameInput = document.getElementById('name');
        const consoleInput = document.getElementById('console');
        const categoryInput = document.getElementById('category');
        const ratingInput = document.getElementById('rating');
        const ratingValueDisplay = document.getElementById('rating-value');
        const notesInput = document.getElementById('notes');
        const coverUrlInput = document.getElementById('coverUrl');
        const searchCoverBtn = document.getElementById('search-cover-btn');
        const searchTip = document.getElementById('search-tip');
        const startDateInput = document.getElementById('startDate'); // Data de In√≠cio
        const endDateInput = document.getElementById('endDate'); // Data de Finaliza√ß√£o
        const saveBtn = document.getElementById('save-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        let loadingMessage = document.getElementById('loading-message');

        const filterBtns = document.querySelectorAll('.filter-btn'); // Bot√µes de Filtro
        const sortBtns = document.querySelectorAll('.sort-btn'); // Bot√µes de Ordena√ß√£o

        // Elementos do Modal de Exclus√£o
        const deleteModal = document.getElementById('delete-modal');
        const modalGameName = document.getElementById('modal-game-name');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        
        let currentUserId = null;
        let unsubscribe = null; 
        let allGames = []; 
        let currentFilter = 'Todos'; 
        let currentSort = 'ratingDesc'; 

        // --- Fun√ß√µes de Ajuda e Configura√ß√µes ---
        
        const consoleIcons = {
            'PC': 'üñ•Ô∏è',
            'PS5': 'üü¶',
            'PS4': 'üî∑',
            'PS3': 'üîµ',
            'PS2': '‚ú®',
            'PS1': 'üïπÔ∏è',
            'XSX': 'üü©',
            'XB1': 'üü¢',
            'XBOX360': '‚ö™',
            'Switch': 'üî¥üîµ',
            'N64': 'üîº',
            'SNES': 'üëæ',
            'NES': 'üß±',
            'MD': '‚ö°',
            'DC': 'üåÄ',
            'GC': 'üü£',
            'Wii': 'üïäÔ∏è',
            'GB': 'üîã',
            'PSP': 'üñêÔ∏è',
            'Mobile': 'üì±',
            'Outro': '‚ùì'
        };

        const getCollectionRef = () => {
            if (!currentUserId || !db || !collection) throw new Error("Recursos do Firebase n√£o dispon√≠veis.");
            return collection(db, `artifacts/${appId}/users/${currentUserId}/game_library`);
        };

        ratingInput.addEventListener('input', () => {
            ratingValueDisplay.textContent = ratingInput.value;
        });

        // --- L√≥gica de Busca de Capa (API-Assistida) ---
        searchCoverBtn.addEventListener('click', () => {
            const gameName = nameInput.value.trim();
            const originalTipText = "Use o bot√£o de busca para pesquisar a capa no Google. Copie o endere√ßo da imagem e cole acima.";

            if (gameName) {
                const query = encodeURIComponent(`${gameName} capa jogo alta resolu√ß√£o`);
                const searchUrl = `https://www.google.com/search?tbm=isch&q=${query}`;
                
                const newWindow = window.open(searchUrl, '_blank');

                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    searchTip.innerHTML = `
                        <span class="text-red-400 font-bold">
                            FALHA NA BUSCA AUTOM√ÅTICA! (Causa: Bloqueador de Pop-up do Chrome) 
                            <br> SOLU√á√ÉO: Clique neste link para abrir manualmente:
                        </span>
                        <a href="${searchUrl}" target="_blank" class="text-indigo-400 underline hover:text-indigo-300 break-words font-semibold">
                            Abrir Busca por Capa de "${gameName}"
                        </a>
                        <br><span class="text-slate-300">Em seguida, copie o endere√ßo da imagem e cole no campo acima.</span>
                    `;
                } else {
                    searchTip.textContent = "Nova aba aberta. Copie o endere√ßo da imagem (bot√£o direito > Copiar endere√ßo da imagem) e cole no campo acima.";
                }

                setTimeout(() => {
                    searchTip.textContent = originalTipText;
                }, 15000); 

            } else {
                searchTip.textContent = "Por favor, digite o Nome do Jogo antes de buscar a capa!";
                setTimeout(() => {
                    searchTip.textContent = originalTipText;
                }, 3000);
            }
        });


        // --- Autentica√ß√£o / Inicializa√ß√£o ---

        const initializeAppMode = async () => {
            if (isLocalDevMode) {
                // MODO DE DESENVOLVIMENTO LOCAL
                currentUserId = 'LOCAL_DEV_USER_ID';
                userIdDisplay.textContent = 'ID do Usu√°rio: MODO LOCAL / OFFLINE';
                userIdDisplay.classList.add('text-yellow-400', 'font-bold');
                
                loadLocalData(); // Carrega dados do localStorage
            
            } else {
                // MODO PRODU√á√ÉO (Com chaves reais)
                if (!auth) {
                    // Se o Auth falhou na inicializa√ß√£o (erro de rede/configura√ß√£o)
                    currentUserId = 'PROD_FAILURE';
                    userIdDisplay.textContent = 'ID do Usu√°rio: FALHA DE CONEX√ÉO';
                    loadingMessage.classList.add('text-red-400', 'font-bold');
                    loadingMessage.innerHTML = 'FALHA DE CONEX√ÉO: N√£o foi poss√≠vel conectar ao Firebase. Verifique sua rede.';
                    return;
                }

                // Tenta autentica√ß√£o normal do Firebase
                try {
                    await setPersistence(auth, browserLocalPersistence);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                } catch (error) {
                    console.error("ERRO CR√çTICO NA AUTENTICA√á√ÉO/CONFIGURA√á√ÉO (PROD):", error);
                    loadingMessage.classList.remove('hidden');
                    loadingMessage.classList.add('text-red-400', 'font-bold');
                    loadingMessage.innerHTML = 'FALHA DE AUTENTICA√á√ÉO. Verifique o console.';
                }
            }
        };

        // Observa a mudan√ßa de estado de autentica√ß√£o (s√≥ ativa em modo PROD)
        if (!isLocalDevMode && typeof onAuthStateChanged !== 'undefined') {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = `ID do Usu√°rio: ${currentUserId}`;
                    console.log("Usu√°rio autenticado:", currentUserId);
                    
                    if (loadingMessage) {
                        loadingMessage.classList.remove('text-red-400', 'font-bold');
                        loadingMessage.textContent = "Carregando sua biblioteca...";
                    }
                    
                    subscribeToGames(); // Inicia a escuta em tempo real do Firestore (PROD)
                } else {
                    currentUserId = null;
                    userIdDisplay.textContent = "ID do Usu√°rio: N√£o autenticado";
                    if (loadingMessage) {
                        loadingMessage.classList.remove('hidden');
                        loadingMessage.textContent = "Fa√ßa login para ver seus jogos.";
                    }
                }
            });
        }


        // --- Persist√™ncia Local (usada apenas no MODO LOCAL/OFFLINE) ---

        const saveLocalData = () => {
            if (isLocalDevMode) {
                localStorage.setItem('localGames', JSON.stringify(allGames));
                applyFilterAndSortAndRender(); 
            }
        };

        const loadLocalData = () => {
            const data = localStorage.getItem('localGames');
            if (data) {
                allGames = JSON.parse(data);
                applyFilterAndSortAndRender();
            } else {
                allGames = [];
            }
            loadingMessage.classList.add('hidden');
        };

        // --- CRUD: CREATE / UPDATE ---

        gameForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUserId) {
                console.error("Opera√ß√£o negada: Usu√°rio n√£o autenticado.");
                return;
            }

            const isEditing = !!gameIdInput.value;
            const now = new Date().toISOString();
            
            const gameData = {
                name: nameInput.value,
                console: consoleInput.value,
                category: categoryInput.value,
                rating: parseInt(ratingInput.value),
                notes: notesInput.value,
                coverUrl: coverUrlInput.value.trim(),
                startDate: startDateInput.value || null, 
                endDate: endDateInput.value || null, 
                timestamp: now, 
            };

            try {
                if (isLocalDevMode) {
                    // MODO LOCAL
                    if (isEditing) {
                        const index = allGames.findIndex(g => g.id === gameIdInput.value);
                        if (index !== -1) {
                            allGames[index] = { id: gameIdInput.value, ...gameData };
                        }
                    } else {
                        gameData.id = Date.now().toString(); 
                        allGames.push({ id: gameData.id, ...gameData });
                    }
                    saveLocalData();
                    console.log("Jogo salvo localmente com sucesso!");

                } else {
                    // MODO PROD: Firebase Firestore
                    if (isEditing) {
                        const collectionRef = getCollectionRef();
                        const gameRef = doc(collectionRef, gameIdInput.value); 
                        await updateDoc(gameRef, { ...gameData, timestamp: serverTimestamp() });
                        console.log("Jogo atualizado com sucesso no Firebase!");
                    } else {
                        await addDoc(getCollectionRef(), { ...gameData, timestamp: serverTimestamp() });
                        console.log("Novo jogo adicionado com sucesso no Firebase!");
                    }
                }

                resetForm();

            } catch (error) {
                console.error("Erro ao salvar o jogo:", error);
            }
        });

        // --- CRUD: READ (onSnapshot / LocalData) ---

        const subscribeToGames = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            
            loadingMessage.classList.remove('hidden');
            gameList.innerHTML = ''; 

            // Apenas para modo PROD (Firebase)
            const gamesQuery = query(getCollectionRef(), orderBy('timestamp', 'desc'));

            unsubscribe = onSnapshot(gamesQuery, (snapshot) => {
                loadingMessage.classList.add('hidden');
                
                if (snapshot.empty) {
                    allGames = []; 
                    gameList.innerHTML = `<p class="text-slate-400 text-center py-8">Nenhum jogo na sua biblioteca ainda. Adicione o primeiro!</p>`;
                    return;
                }

                allGames = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                applyFilterAndSortAndRender();
                
            }, (error) => {
                console.error("Erro ao receber dados em tempo real:", error);
                gameList.innerHTML = `<p class="text-red-400 text-center py-8">Erro ao carregar dados: ${error.message}</p>`;
            });
        };

        // --- L√≥gica de Filtro e Ordena√ß√£o Local (Usada em ambos os modos) ---

        const applyFilterAndSortAndRender = () => {
            let filteredGames = [...allGames];

            // 1. Aplica Filtragem
            if (currentFilter !== 'Todos') {
                filteredGames = filteredGames.filter(game => game.category === currentFilter);
            }

            // 2. Aplica Ordena√ß√£o
            filteredGames.sort((a, b) => {
                if (currentSort === 'ratingDesc') {
                    // Maior Nota primeiro
                    return b.rating - a.rating; 
                } else if (currentSort === 'ratingAsc') {
                    // Menor Nota primeiro
                    return a.rating - b.rating;
                }
                // Fallback: ordenar por nome
                return a.name.localeCompare(b.name);
            });

            // 3. Renderiza
            if (filteredGames.length === 0) {
                gameList.innerHTML = `<p class="text-slate-400 text-center py-8">Nenhum jogo encontrado com o filtro atual.</p>`;
            } else {
                filteredGames.forEach(game => {
                    delete game.timestamp; 
                });
                gameList.innerHTML = filteredGames.map(game => createGameCard(game)).join('');
            }
        }

        // --- Configura√ß√£o dos Bot√µes de Filtro e Ordena√ß√£o ---

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentFilter = btn.dataset.filter;
                filterBtns.forEach(b => {
                    const isSelected = b.dataset.filter === currentFilter;
                    b.classList.toggle('bg-indigo-600', isSelected);
                    b.classList.toggle('text-white', isSelected);
                    b.classList.toggle('border-indigo-700', isSelected);

                    b.classList.toggle('bg-slate-700', !isSelected);
                    b.classList.toggle('text-slate-300', !isSelected);
                    b.classList.toggle('border-slate-600', !isSelected);
                });
                applyFilterAndSortAndRender();
            });
        });

        sortBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentSort = btn.dataset.sort;
                sortBtns.forEach(b => {
                    const isSelected = b.dataset.sort === currentSort;
                    b.classList.toggle('bg-indigo-600', isSelected);
                    b.classList.toggle('text-white', isSelected);
                    b.classList.toggle('border-indigo-700', isSelected);

                    b.classList.toggle('bg-slate-700', !isSelected);
                    b.classList.toggle('text-slate-300', !isSelected);
                    b.classList.toggle('border-slate-600', !isSelected);
                });
                applyFilterAndSortAndRender();
            });
        });

        // --- Renderiza√ß√£o da Interface ---

        const createGameCard = (game) => {
            const id = game.id;
            const ratingColor = game.rating >= 8 ? 'bg-green-500' : game.rating >= 5 ? 'bg-yellow-500' : 'bg-red-500';
            const ratingPercent = (game.rating / 10) * 100;
            
            let categoryClasses = 'px-3 py-1 rounded-full text-xs font-semibold';
            switch(game.category) {
                case 'Zerado':
                    categoryClasses += ' bg-green-500 text-green-900';
                    break;
                case 'Jogando':
                    categoryClasses += ' bg-blue-500 text-blue-900';
                    break;
                case 'Desejo Jogar':
                    categoryClasses += ' bg-indigo-500 text-indigo-900';
                    break;
                case 'Abandonado':
                    categoryClasses += ' bg-red-500 text-red-900';
                    break;
                default:
                    categoryClasses += ' bg-slate-500 text-slate-900';
            }

            const coverHtml = game.coverUrl ? 
                `<img src="${game.coverUrl}" 
                      alt="Capa do Jogo ${game.name}" 
                      class="w-20 h-28 object-cover rounded-lg mr-4 flex-shrink-0"
                      onerror="this.onerror=null; this.src='https://placehold.co/80x112/1f2937/d1d5db?text=Sem+Capa';">` : 
                `<div class="w-20 h-28 bg-slate-700 rounded-lg mr-4 flex-shrink-0 flex items-center justify-center text-xs text-slate-500 text-center p-2 leading-tight">Sem Capa</div>`;

            // √çcone do Console
            const consoleIcon = consoleIcons[game.console] || consoleIcons['Outro'];
            
            // Exibi√ß√£o das datas
            const startDateDisplay = game.startDate ? `<span class="font-semibold text-slate-300">${game.startDate}</span>` : 'N/A';
            const endDateDisplay = game.endDate ? `<span class="font-semibold text-slate-300">${game.endDate}</span>` : 'N/A';


            return `
                <div class="game-card bg-slate-800 p-4 rounded-xl flex items-start md:items-center border-l-4 border-indigo-600">
                    
                    ${coverHtml} <!-- Capa/Placeholder -->

                    <!-- Bloco Principal (Texto e Avalia√ß√£o) -->
                    <div class="flex flex-col md:flex-row flex-grow justify-between items-start w-full min-w-0">
                        
                        <!-- Bloco de Texto (Nome, Console, Obs) -->
                        <div class="flex-grow min-w-0 mb-4 md:mb-0 pr-4">
                            <div class="flex items-center space-x-3 mb-1">
                                <span class="${categoryClasses}">${game.category}</span>
                                <h3 class="text-xl font-bold text-white truncate">${game.name}</h3>
                            </div>
                            <p class="text-slate-400 text-sm mb-1">
                                <!-- INSER√á√ÉO DO √çCONE DO CONSOLE AQUI -->
                                <span class="text-lg mr-1 align-middle">${consoleIcon}</span>
                                Console: <span class="font-semibold text-slate-300">${game.console}</span> 
                                | In√≠cio: ${startDateDisplay} 
                                | Fim: ${endDateDisplay}
                            </p>
                            <p class="text-slate-300 text-sm italic overflow-hidden whitespace-nowrap text-ellipsis">Obs: ${game.notes || 'Sem observa√ß√µes.'}</p>
                        </div>
                        
                        <!-- Bloco de Avalia√ß√£o e A√ß√µes -->
                        <div class="flex-shrink-0 w-full md:w-56 space-y-2 md:ml-4">
                            <!-- Visualiza√ß√£o da Nota -->
                            <div class="flex items-center justify-between text-white text-sm font-semibold">
                                <span>Nota:</span>
                                <span class="text-lg text-indigo-400">${game.rating}/10</span>
                            </div>
                            <div class="bg-slate-700 rating-bar w-full">
                                <div class="rating-bar ${ratingColor}" style="width: ${ratingPercent}%;"></div>
                            </div>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="flex space-x-2 pt-2 justify-end">
                                <button data-id="${id}" data-game='${JSON.stringify(game)}' class="edit-btn px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                                    Editar
                                </button>
                                <button data-id="${id}" data-name="${game.name}" class="delete-btn px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // Adiciona listeners aos bot√µes de Editar e Excluir
        gameList.addEventListener('click', (e) => {
            const target = e.target;
            
            if (target.classList.contains('edit-btn')) {
                const gameData = JSON.parse(target.dataset.game);
                const id = target.dataset.id;
                fillFormForEdit(id, gameData);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            
            } else if (target.classList.contains('delete-btn')) {
                const id = target.dataset.id;
                const name = target.dataset.name;
                openDeleteModal(id, name);
            }
        });
        
        const fillFormForEdit = (id, game) => {
            gameIdInput.value = id;
            nameInput.value = game.name;
            consoleInput.value = game.console;
            categoryInput.value = game.category;
            ratingInput.value = game.rating;
            ratingValueDisplay.textContent = game.rating;
            notesInput.value = game.notes;
            coverUrlInput.value = game.coverUrl || '';
            startDateInput.value = game.startDate || ''; 
            endDateInput.value = game.endDate || ''; 

            formTitle.textContent = 'Editar Jogo: ' + game.name;
            saveBtn.textContent = 'Salvar Edi√ß√£o';
            cancelEditBtn.classList.remove('hidden');
        };

        const resetForm = () => {
            gameForm.reset();
            gameIdInput.value = '';
            formTitle.textContent = 'Adicionar Novo Jogo';
            saveBtn.textContent = 'Salvar Jogo';
            ratingInput.value = 5;
            ratingValueDisplay.textContent = 5;
            cancelEditBtn.classList.add('hidden');
            searchTip.textContent = "Use o bot√£o de busca para pesquisar a capa no Google. Copie o endere√ßo da imagem e cole acima.";
        };

        cancelEditBtn.addEventListener('click', resetForm);

        // --- CRUD: DELETE (Modal Customizado) ---

        let gameToDeleteId = null;

        const openDeleteModal = (id, name) => {
            gameToDeleteId = id;
            modalGameName.textContent = name;
            deleteModal.classList.remove('hidden');
        };

        const closeDeleteModal = () => {
            gameToDeleteId = null;
            deleteModal.classList.add('hidden');
        };

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);

        confirmDeleteBtn.addEventListener('click', async () => {
            if (gameToDeleteId && currentUserId) {
                try {
                    if (isLocalDevMode) {
                        // MODO LOCAL
                        allGames = allGames.filter(game => game.id !== gameToDeleteId);
                        saveLocalData();
                        console.log("Jogo exclu√≠do localmente com sucesso!");

                    } else {
                        // MODO PROD
                        const collectionRef = getCollectionRef();
                        const gameRef = doc(collectionRef, gameToDeleteId);
                        await deleteDoc(gameRef);
                        console.log("Jogo exclu√≠do do Firebase com sucesso!");
                    }
                    
                    closeDeleteModal();
                    if (gameIdInput.value === gameToDeleteId) {
                        resetForm();
                    }
                } catch (error) {
                    console.error("Erro ao excluir o jogo:", error);
                }
            }
        });

        // --- Inicializa√ß√£o ---
        initializeAppMode();
    </script>
</body>
</html>