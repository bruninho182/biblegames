<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Biblioteca de Games</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="./img/favicon-16x16.png" type="image/x-icon">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate-900 */
        }
        /* Estilos personalizados para o app (n√£o-Tailwind) */
        .game-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .game-card:hover {
            transform: translateY(-2px);
        }
        .rating-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease-out;
        }
        .container-lg {
            max-width: 1024px;
        }
        /* Estiliza√ß√£o b√°sica para input[type="date"] no tema escuro */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Torna o √≠cone do calend√°rio branco */
            cursor: pointer;
        }
        /* Permite quebras de linha nas observa√ß√µes do modal */
        #modal-details-notes {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="container-lg mx-auto">
        <header class="text-center mb-8">
            <!-- MASCOTE AGORA √â UMA IMAGEM PLACEHOLDER. SUBSTITUA O SRC PELA URL DA SUA IMAGEM (PNG/GIF) -->
            <h1 class="text-4xl font-extrabold text-white mb-2 flex items-center justify-center">
                <img id="mascot-img" 
                     src="./img/mascote.png" 
                     alt="Mascote da Biblioteca" 
                     class="w-10 h-10 mr-3 rounded-full object-cover">
                Biblioteca de Games
            </h1>
            <p id="user-id-display" class="text-sm text-slate-400">ID do Usu√°rio: Carregando...</p>
            <p class="text-lg text-slate-300">Organize, avalie e documente seus jogos.</p>
        </header>

        <!-- Formul√°rio para Adicionar/Editar Jogo -->
        <div id="game-form-container" class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl mb-8">
            <h2 id="form-title" class="text-2xl font-semibold text-white mb-4">Adicionar Novo Jogo</h2>
            <form id="game-form" class="space-y-4">
                <input type="hidden" id="game-id">

                <!-- Nome do Jogo -->
                <div>
                    <label for="name" class="block text-sm font-medium text-slate-300">Nome do Jogo</label>
                    <input type="text" id="name" required class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- URL da Capa e Busca -->
                <div>
                    <label for="coverUrl" class="block text-sm font-medium text-slate-300">URL da Capa do Jogo (Opcional)</label>
                    <div class="flex space-x-2 mt-1">
                        <input type="url" id="coverUrl" class="block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: https://caminho.para/sua_capa.jpg">
                        <button type="button" id="search-cover-btn" class="flex-shrink-0 px-4 py-2 bg-pink-600 text-white font-medium rounded-lg hover:bg-pink-700 transition-colors">
                            Buscar Capa
                        </button>
                    </div>
                    <p id="search-tip" class="text-xs text-slate-500 mt-1">Use o bot√£o de busca para pesquisar a capa no Google. Copie o endere√ßo da imagem e cole acima.</p>
                </div>
                
                <!-- NOVOS CAMPOS: Datas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Data de In√≠cio -->
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-slate-300">Data de In√≠cio (Opcional)</label>
                        <input type="date" id="startDate" class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Data de Finaliza√ß√£o -->
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-slate-300">Data de Finaliza√ß√£o (Opcional)</label>
                        <input type="date" id="endDate" class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Console/Plataforma (OP√á√ïES EXPANDIDAS) -->
                    <div>
                        <label for="console" class="block text-sm font-medium text-slate-300">Console/Plataforma</label>
                        <select id="console" required class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Selecione</option>
                            <optgroup label="Atual/Moderno">
                                <option value="PC">PC</option>
                                <option value="PS5">PlayStation 5</option>
                                <option value="PS4">PlayStation 4</option>
                                <option value="XSX">Xbox Series X|S</option>
                                <option value="XB1">Xbox One</option>
                                <option value="Switch">Nintendo Switch</option>
                                <option value="Mobile">Mobile</option>
                            </optgroup>
                            <optgroup label="Cl√°ssico/Retro">
                                <option value="PS3">PlayStation 3</option>
                                <option value="PS2">PlayStation 2</option>
                                <option value="PS1">PlayStation 1 (PSX)</option>
                                <option value="XBOX360">Xbox 360</option>
                                <option value="N64">Nintendo 64</option>
                                <option value="SNES">Super Nintendo (SNES)</option>
                                <option value="NES">Nintendo (NES)</option>
                                <option value="MD">Mega Drive</option>
                                <option value="DC">Dreamcast</option>
                                <option value="GC">GameCube</option>
                                <option value="Wii">Wii</option>
                                <option value="GB">Game Boy / GBA</option>
                                <option value="PSP">PSP / Vita</option>
                            </optgroup>
                            <option value="Outro">Outro/Customizado</option>
                        </select>
                    </div>

                    <!-- Categoria -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-slate-300">Categoria</label>
                        <select id="category" required class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Desejo Jogar">Desejo Jogar</option>
                            <option value="Jogando">Jogando</option>
                            <option value="Zerado">Zerado</option>
                            <option value="Abandonado">Abandonado</option>
                        </select>
                    </div>

                    <!-- Nota (1-10) -->
                    <div>
                        <label for="rating" class="block text-sm font-medium text-slate-300">Nota (0-10)</label>
                        <input type="range" id="rating" min="0" max="10" step="1" value="5" class="mt-1 block w-full h-8 cursor-pointer appearance-none bg-slate-700 rounded-lg">
                        <p id="rating-value" class="text-center text-indigo-400 font-bold mt-1 text-lg">5</p>
                    </div>
                </div>
                
                <!-- Observa√ß√µes -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-slate-300">Observa√ß√µes</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancel-edit-btn" class="hidden px-4 py-2 bg-slate-600 text-white font-medium rounded-lg hover:bg-slate-500 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" id="save-btn" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/50">
                        Salvar Jogo
                    </button>
                </div>
            </form>
        </div>

        <!-- NOVO BLOCO: Controles de Filtros e Ordena√ß√£o -->
        <div class="bg-slate-800 p-4 rounded-xl shadow-2xl mb-6 flex flex-col space-y-4">
            
            <!-- Pesquisa R√°pida (Nova Se√ß√£o) -->
            <div>
                <label for="search-input" class="block text-sm font-medium text-slate-300 mb-1">Pesquisa R√°pida (Nome, Console, Obs)</label>
                <input type="text" id="search-input" placeholder="Digite para buscar na biblioteca..." class="block w-full rounded-lg border-none bg-slate-700 text-white placeholder-slate-400 p-3 shadow-sm focus:ring-pink-500 focus:border-pink-500">
            </div>

            <div class="flex flex-col md:flex-row md:items-center justify-between space-y-4 md:space-y-0">
                
                <!-- Filtro por Categoria (Desktop/Tablet) -->
                <div class="hidden md:flex flex-wrap items-center">
                    <label class="text-slate-300 text-sm font-medium mr-3 w-full md:w-auto">Filtrar por Categoria:</label>
                    <div class="inline-flex rounded-lg shadow-sm w-full md:w-auto" role="group">
                        <button type="button" data-filter="Todos" class="filter-btn px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-l-lg border border-indigo-700 hover:bg-indigo-700 transition-colors">
                            Todos
                        </button>
                        <button type="button" data-filter="Zerado" class="filter-btn px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 border-t border-b border-slate-600 hover:bg-slate-600 transition-colors">
                            Zerado
                        </button>
                        <button type="button" data-filter="Jogando" class="filter-btn px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 border-t border-b border-slate-600 hover:bg-slate-600 transition-colors">
                            Jogando
                        </button>
                        <button type="button" data-filter="Desejo Jogar" class="filter-btn px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 rounded-r-lg border border-slate-600 hover:bg-slate-600 transition-colors">
                            Desejo Jogar
                        </button>
                    </div>
                </div>
                
                <!-- Filtro por Categoria (M√≥vel) -->
                <div class="md:hidden w-full">
                    <label for="mobile-filter-category" class="block text-sm font-medium text-slate-300 mb-1">Filtrar por Categoria:</label>
                    <select id="mobile-filter-category" class="block w-full rounded-lg border-none bg-slate-700 text-white p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Todos">Todos</option>
                        <option value="Zerado">Zerado</option>
                        <option value="Jogando">Jogando</option>
                        <option value="Desejo Jogar">Desejo Jogar</option>
                    </select>
                </div>

                <!-- Ordena√ß√£o por Nota (Desktop/Tablet) -->
                <div class="hidden md:flex flex-wrap items-center">
                    <label class="text-slate-300 text-sm font-medium mr-3 w-full md:w-auto">Ordenar por Nota:</label>
                    <div class="inline-flex rounded-lg shadow-sm w-full md:w-auto" role="group">
                        <button type="button" data-sort="ratingDesc" class="sort-btn px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-l-lg border border-indigo-700 hover:bg-indigo-700 transition-colors">
                            Maior Nota
                        </button>
                        <button type="button" data-sort="ratingAsc" class="sort-btn px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 rounded-r-lg border border-slate-600 hover:bg-slate-600 transition-colors">
                            Menor Nota
                        </button>
                    </div>
                </div>

                <!-- Ordena√ß√£o por Nota (M√≥vel) -->
                <div class="md:hidden w-full">
                    <label for="mobile-sort" class="block text-sm font-medium text-slate-300 mb-1">Ordenar por Nota:</label>
                    <select id="mobile-sort" class="block w-full rounded-lg border-none bg-slate-700 text-white p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="ratingDesc">Maior Nota</option>
                        <option value="ratingAsc">Menor Nota</option>
                    </select>
                </div>

            </div>

        </div>
        <!-- Fim Controles -->
        
        <!-- NOVO: Bot√µes de Exporta√ß√£o e Importa√ß√£o -->
        <div class="flex flex-col sm:flex-row justify-end mb-4 space-y-2 sm:space-y-0 sm:space-x-2">
            <!-- Arquivo de Importa√ß√£o (Hidden) -->
            <input type="file" id="import-file-input" accept=".csv" class="hidden">
            
            <button type="button" id="import-btn" class="px-4 py-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors shadow-md">
                Importar Dados (CSV)
            </button>
            <button type="button" id="export-btn" class="px-4 py-2 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition-colors shadow-md">
                Exportar Dados (CSV)
            </button>
        </div>

        <!-- Lista de Jogos -->
        <div class="bg-slate-900 p-4 md:p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold text-white mb-4">Meus Jogos</h2>
            <div id="game-list" class="space-y-4">
                <!-- Jogos ser√£o injetados aqui -->
                <p id="loading-message" class="text-slate-400 text-center py-8">Carregando sua biblioteca...</p>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o (customizado) -->
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-slate-800 rounded-xl p-6 w-11/12 max-w-sm shadow-2xl border border-red-600/50">
                <h3 class="text-xl font-bold text-red-400 mb-4">Confirmar Exclus√£o</h3>
                <p class="text-slate-300 mb-6">Tem certeza de que deseja excluir o jogo "<span id="modal-game-name" class="font-semibold text-white"></span>"? Esta a√ß√£o n√£o pode ser desfeita.</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500">Cancelar</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Excluir</button>
                </div>
            </div>
        </div>

        <!-- Modal de Detalhes do Jogo -->
        <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-slate-800 rounded-xl p-6 w-full max-w-lg shadow-2xl border border-indigo-600/50 relative">
                <button id="close-details-btn" class="absolute top-3 right-3 text-slate-400 hover:text-white text-2xl">
                    &times;
                </button>
                <h3 id="modal-details-title" class="text-2xl font-bold text-white mb-2"></h3>
                <p id="modal-details-subtitle" class="text-sm text-slate-400 mb-4"></p>
                
                <div class="space-y-4 text-slate-300">
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span class="font-semibold">Categoria:</span>
                        <span id="modal-details-category" class="font-bold text-indigo-400"></span>
                    </div>
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span class="font-semibold">Nota:</span>
                        <span id="modal-details-rating" class="font-bold text-green-400"></span>
                    </div>
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span class="font-semibold">In√≠cio:</span>
                        <span id="modal-details-start-date"></span>
                    </div>
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span class="font-semibold">Fim:</span>
                        <span id="modal-details-end-date"></span>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-white pt-2 border-t border-slate-700">Observa√ß√µes:</h4>
                    <p id="modal-details-notes" class="text-slate-300 bg-slate-700 p-3 rounded-lg text-sm italic"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports (Module) -->
    <script type="module">
        // Importa apenas as fun√ß√µes necess√°rias (se a inicializa√ß√£o for chamada)
        let initializeApp, getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence, setLogLevel;

        // Tenta importar as depend√™ncias do Firebase.
        try {
            const firebaseAppModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            initializeApp = firebaseAppModule.initializeApp;

            const firestoreModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            getFirestore = firestoreModule.getFirestore;
            collection = firestoreModule.collection;
            addDoc = firestoreModule.addDoc;
            doc = firestoreModule.doc;
            updateDoc = firestoreModule.updateDoc;
            deleteDoc = firestoreModule.deleteDoc;
            onSnapshot = firestoreModule.onSnapshot;
            query = firestoreModule.query;
            orderBy = firestoreModule.orderBy;
            serverTimestamp = firestoreModule.serverTimestamp;
            setLogLevel = firestoreModule.setLogLevel;

            const authModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            getAuth = authModule.getAuth;
            signInAnonymously = authModule.signInAnonymously;
            signInWithCustomToken = authModule.signInWithCustomToken;
            onAuthStateChanged = authModule.onAuthStateChanged;
            setPersistence = authModule.setPersistence;
            browserLocalPersistence = authModule.browserLocalPersistence;

            // setLogLevel('Debug'); // Deixamos o debug desativado para evitar polui√ß√£o no console no modo local
        } catch (e) {
            console.warn("Firebase imports skipped. Running in Local/Offline mode.");
        }


        // Vari√°veis globais do ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Configura√ß√µes e detec√ß√£o de modo local
        const DUMMY_API_KEY = "dummy-key";
        const defaultFirebaseConfig = {
            projectId: "local-dev-project", 
            apiKey: DUMMY_API_KEY, 
            // O restante das chaves √© irrelevante no modo dev local, pois n√£o faremos a conex√£o.
        };
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' && __firebase_config ? __firebase_config : JSON.stringify(defaultFirebaseConfig));
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Vari√°vel de controle: se a chave API for a dummy, estamos no modo de desenvolvimento local.
        const isLocalDevMode = firebaseConfig.apiKey === DUMMY_API_KEY;


        // Vari√°veis de Firebase (ser√£o nulas no modo local)
        let app = null;
        let db = null;
        let auth = null;
        
        // Inicializa√ß√£o Condicional
        if (!isLocalDevMode) {
            // MODO PRODU√á√ÉO (Canvas/Ambiente com chaves reais): Inicializa o Firebase
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Falha ao inicializar o Firebase em modo PROD:", error);
            }
        }
        
        
        // Elementos do DOM
        const gameForm = document.getElementById('game-form');
        const gameList = document.getElementById('game-list');
        const formTitle = document.getElementById('form-title');
        const gameIdInput = document.getElementById('game-id');
        const nameInput = document.getElementById('name');
        const consoleInput = document.getElementById('console');
        const categoryInput = document.getElementById('category');
        const ratingInput = document.getElementById('rating');
        const ratingValueDisplay = document.getElementById('rating-value');
        const notesInput = document.getElementById('notes');
        const coverUrlInput = document.getElementById('coverUrl');
        const searchCoverBtn = document.getElementById('search-cover-btn');
        const searchTip = document.getElementById('search-tip');
        const startDateInput = document.getElementById('startDate'); // Data de In√≠cio
        const endDateInput = document.getElementById('endDate'); // Data de Finaliza√ß√£o
        const saveBtn = document.getElementById('save-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        let loadingMessage = document.getElementById('loading-message');
        
        const exportBtn = document.getElementById('export-btn'); 
        const importBtn = document.getElementById('import-btn'); // NOVO: Bot√£o de Importar
        const importFileInput = document.getElementById('import-file-input'); // NOVO: Input de Arquivo
        const searchInput = document.getElementById('search-input'); // NOVO: Input de Pesquisa R√°pida

        const mobileFilterCategory = document.getElementById('mobile-filter-category'); 
        const mobileSort = document.getElementById('mobile-sort'); 

        const filterBtns = document.querySelectorAll('.filter-btn'); 
        const sortBtns = document.querySelectorAll('.sort-btn'); 

        // Elementos do Modal de Exclus√£o
        const deleteModal = document.getElementById('delete-modal');
        const modalGameName = document.getElementById('modal-game-name');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        
        // Elementos do Modal de Detalhes
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsBtn = document.getElementById('close-details-btn');
        const modalDetailsTitle = document.getElementById('modal-details-title');
        const modalDetailsSubtitle = document.getElementById('modal-details-subtitle');
        const modalDetailsCategory = document.getElementById('modal-details-category');
        const modalDetailsRating = document.getElementById('modal-details-rating');
        const modalDetailsStartDate = document.getElementById('modal-details-start-date');
        const modalDetailsEndDate = document.getElementById('modal-details-end-date');
        const modalDetailsNotes = document.getElementById('modal-details-notes');
        
        let currentUserId = null;
        let unsubscribe = null; 
        let allGames = []; 
        let currentFilter = 'Todos'; 
        let currentSort = 'ratingDesc'; 
        let currentSearchTerm = ''; // NOVO: Termo de pesquisa atual

        // --- Fun√ß√µes de Ajuda e Configura√ß√µes ---
        
        const consoleIcons = {
            'PC': 'üñ•Ô∏è',
            'PS5': 'üü¶',
            'PS4': 'üî∑',
            'PS3': 'üîµ',
            'PS2': '‚ú®',
            'PS1': 'üïπÔ∏è',
            'XSX': 'üü©',
            'XB1': 'üü¢',
            'XBOX360': '‚ö™',
            'Switch': 'üî¥üîµ',
            'N64': 'üîº',
            'SNES': 'üëæ',
            'NES': 'üß±',
            'MD': '‚ö°',
            'DC': 'üåÄ',
            'GC': 'üü£',
            'Wii': 'üïäÔ∏è',
            'GB': 'üîã',
            'PSP': 'üñêÔ∏è',
            'Mobile': 'üì±',
            'Outro': '‚ùì'
        };

        const getCollectionRef = () => {
            if (!currentUserId || !db || !collection) throw new Error("Recursos do Firebase n√£o dispon√≠veis.");
            return collection(db, `artifacts/${appId}/users/${currentUserId}/game_library`);
        };

        ratingInput.addEventListener('input', () => {
            ratingValueDisplay.textContent = ratingInput.value;
        });

        // --- L√≥gica de Busca de Capa (API-Assistida) ---
        searchCoverBtn.addEventListener('click', () => {
            const gameName = nameInput.value.trim();
            const originalTipText = "Use o bot√£o de busca para pesquisar a capa no Google. Copie o endere√ßo da imagem e cole acima.";

            if (gameName) {
                const query = encodeURIComponent(`${gameName} capa jogo alta resolu√ß√£o`);
                const searchUrl = `https://www.google.com/search?tbm=isch&q=${query}`;
                
                const newWindow = window.open(searchUrl, '_blank');

                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    searchTip.innerHTML = `
                        <span class="text-red-400 font-bold">
                            FALHA NA BUSCA AUTOM√ÅTICA! (Causa: Bloqueador de Pop-up do Chrome) 
                            <br> SOLU√á√ÉO: Clique neste link para abrir manualmente:
                        </span>
                        <a href="${searchUrl}" target="_blank" class="text-indigo-400 underline hover:text-indigo-300 break-words font-semibold">
                            Abrir Busca por Capa de "${gameName}"
                        </a>
                        <br><span class="text-slate-300">Em seguida, copie o endere√ßo da imagem e cole no campo acima.</span>
                    `;
                } else {
                    searchTip.textContent = "Nova aba aberta. Copie o endere√ßo da imagem (bot√£o direito > Copiar endere√ßo da imagem) e cole no campo acima.";
                }

                setTimeout(() => {
                    searchTip.textContent = originalTipText;
                }, 15000); 

            } else {
                searchTip.textContent = "Por favor, digite o Nome do Jogo antes de buscar a capa!";
                setTimeout(() => {
                    searchTip.textContent = originalTipText;
                }, 3000);
            }
        });


        // --- Autentica√ß√£o / Inicializa√ß√£o ---

        const initializeAppMode = async () => {
            if (isLocalDevMode) {
                // MODO DE DESENVOLVIMENTO LOCAL
                currentUserId = 'LOCAL_DEV_USER_ID';
                userIdDisplay.textContent = 'ID do Usu√°rio: MODO LOCAL / OFFLINE';
                userIdDisplay.classList.add('text-yellow-400', 'font-bold');
                
                loadLocalData(); // Carrega dados do localStorage
            
            } else {
                // MODO PRODU√á√ÉO (Com chaves reais)
                if (!auth) {
                    // Se o Auth falhou na inicializa√ß√£o (erro de rede/configura√ß√£o)
                    currentUserId = 'PROD_FAILURE';
                    userIdDisplay.textContent = 'ID do Usu√°rio: FALHA DE CONEX√ÉO';
                    loadingMessage.classList.add('text-red-400', 'font-bold');
                    loadingMessage.innerHTML = 'FALHA DE CONEX√ÉO: N√£o foi poss√≠vel conectar ao Firebase. Verifique sua rede.';
                    return;
                }

                // Tenta autentica√ß√£o normal do Firebase
                try {
                    await setPersistence(auth, browserLocalPersistence);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                } catch (error) {
                    console.error("ERRO CR√çTICO NA AUTENTICA√á√ÉO/CONFIGURA√á√ÉO (PROD):", error);
                    loadingMessage.classList.remove('hidden');
                    loadingMessage.classList.add('text-red-400', 'font-bold');
                    loadingMessage.innerHTML = 'FALHA DE AUTENTICA√á√ÉO. Verifique o console.';
                }
            }
        };

        // Observa a mudan√ßa de estado de autentica√ß√£o (s√≥ ativa em modo PROD)
        if (!isLocalDevMode && typeof onAuthStateChanged !== 'undefined') {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = `ID do Usu√°rio: ${currentUserId}`;
                    console.log("Usu√°rio autenticado:", currentUserId);
                    
                    if (loadingMessage) {
                        loadingMessage.classList.remove('text-red-400', 'font-bold');
                        loadingMessage.textContent = "Carregando sua biblioteca...";
                    }
                    
                    subscribeToGames(); // Inicia a escuta em tempo real do Firestore (PROD)
                } else {
                    currentUserId = null;
                    userIdDisplay.textContent = "ID do Usu√°rio: N√£o autenticado";
                    if (loadingMessage) {
                        loadingMessage.classList.remove('hidden');
                        loadingMessage.textContent = "Fa√ßa login para ver seus jogos.";
                    }
                }
            });
        }


        // --- Persist√™ncia Local (usada apenas no MODO LOCAL/OFFLINE) ---

        const saveLocalData = () => {
            if (isLocalDevMode) {
                localStorage.setItem('localGames', JSON.stringify(allGames));
                applyFilterAndSortAndRender(); 
            }
        };

        const loadLocalData = () => {
            const data = localStorage.getItem('localGames');
            if (data) {
                allGames = JSON.parse(data);
                applyFilterAndSortAndRender();
            } else {
                allGames = [];
            }
            loadingMessage.classList.add('hidden');
        };

        // --- CRUD: CREATE / UPDATE ---

        gameForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUserId) {
                console.error("Opera√ß√£o negada: Usu√°rio n√£o autenticado.");
                return;
            }

            const isEditing = !!gameIdInput.value;
            const now = new Date().toISOString();
            
            const gameData = {
                name: nameInput.value,
                console: consoleInput.value,
                category: categoryInput.value,
                rating: parseInt(ratingInput.value),
                notes: notesInput.value,
                coverUrl: coverUrlInput.value.trim(),
                startDate: startDateInput.value || null, 
                endDate: endDateInput.value || null, 
                timestamp: now, 
            };

            try {
                if (isLocalDevMode) {
                    // MODO LOCAL
                    if (isEditing) {
                        const index = allGames.findIndex(g => g.id === gameIdInput.value);
                        if (index !== -1) {
                            allGames[index] = { id: gameIdInput.value, ...gameData };
                        }
                    } else {
                        gameData.id = Date.now().toString(); 
                        allGames.push({ id: gameData.id, ...gameData });
                    }
                    saveLocalData();
                    console.log("Jogo salvo localmente com sucesso!");

                } else {
                    // MODO PROD: Firebase Firestore
                    if (isEditing) {
                        const collectionRef = getCollectionRef();
                        const gameRef = doc(collectionRef, gameIdInput.value); 
                        await updateDoc(gameRef, { ...gameData, timestamp: serverTimestamp() });
                        console.log("Jogo atualizado com sucesso no Firebase!");
                    } else {
                        await addDoc(getCollectionRef(), { ...gameData, timestamp: serverTimestamp() });
                        console.log("Novo jogo adicionado com sucesso no Firebase!");
                    }
                }

                resetForm();

            } catch (error) {
                console.error("Erro ao salvar o jogo:", error);
            }
        });

        // --- CRUD: READ (onSnapshot / LocalData) ---

        const subscribeToGames = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            
            loadingMessage.classList.remove('hidden');
            gameList.innerHTML = ''; 

            // Apenas para modo PROD (Firebase)
            const gamesQuery = query(getCollectionRef(), orderBy('timestamp', 'desc'));

            unsubscribe = onSnapshot(gamesQuery, (snapshot) => {
                loadingMessage.classList.add('hidden');
                
                if (snapshot.empty) {
                    allGames = []; 
                    gameList.innerHTML = `<p class="text-slate-400 text-center py-8">Nenhum jogo na sua biblioteca ainda. Adicione o primeiro!</p>`;
                    return;
                }

                allGames = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                applyFilterAndSortAndRender();
                
            }, (error) => {
                console.error("Erro ao receber dados em tempo real:", error);
                gameList.innerHTML = `<p class="text-red-400 text-center py-8">Erro ao carregar dados: ${error.message}</p>`;
            });
        };

        // --- L√≥gica de Filtro, Ordena√ß√£o e Pesquisa (Usada em ambos os modos) ---

        const applyFilterAndSortAndRender = () => {
            let filteredGames = [...allGames];
            const searchTerm = currentSearchTerm.toLowerCase();

            // 1. Aplica Pesquisa (NOVO)
            if (searchTerm) {
                filteredGames = filteredGames.filter(game => 
                    game.name.toLowerCase().includes(searchTerm) ||
                    game.console.toLowerCase().includes(searchTerm) ||
                    game.category.toLowerCase().includes(searchTerm) ||
                    (game.notes && game.notes.toLowerCase().includes(searchTerm)) // Adiciona verifica√ß√£o de null/undefined para notas
                );
            }

            // 2. Aplica Filtragem
            if (currentFilter !== 'Todos') {
                filteredGames = filteredGames.filter(game => game.category === currentFilter);
            }

            // 3. Aplica Ordena√ß√£o
            filteredGames.sort((a, b) => {
                if (currentSort === 'ratingDesc') {
                    // Maior Nota primeiro
                    return b.rating - a.rating; 
                } else if (currentSort === 'ratingAsc') {
                    // Menor Nota primeiro
                    return a.rating - b.rating;
                }
                // Fallback: ordenar por nome
                return a.name.localeCompare(b.name);
            });

            // 4. Renderiza
            if (filteredGames.length === 0) {
                gameList.innerHTML = `<p class="text-slate-400 text-center py-8">Nenhum jogo encontrado com os filtros e termo de pesquisa atuais.</p>`;
            } else {
                filteredGames.forEach(game => {
                    delete game.timestamp; 
                });
                gameList.innerHTML = filteredGames.map(game => createGameCard(game)).join('');
            }
        }

        // --- Configura√ß√£o dos Bot√µes de Filtro e Ordena√ß√£o ---

        // Configura√ß√£o para bot√µes de DESKTOP
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentFilter = btn.dataset.filter;
                mobileFilterCategory.value = currentFilter; // Sincroniza o mobile
                filterBtns.forEach(b => {
                    const isSelected = b.dataset.filter === currentFilter;
                    b.classList.toggle('bg-indigo-600', isSelected);
                    b.classList.toggle('text-white', isSelected);
                    b.classList.toggle('border-indigo-700', isSelected);

                    b.classList.toggle('bg-slate-700', !isSelected);
                    b.classList.toggle('text-slate-300', !isSelected);
                    b.classList.toggle('border-slate-600', !isSelected);
                });
                applyFilterAndSortAndRender();
            });
        });

        sortBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentSort = btn.dataset.sort;
                mobileSort.value = currentSort; // Sincroniza o mobile
                sortBtns.forEach(b => {
                    const isSelected = b.dataset.sort === currentSort;
                    b.classList.toggle('bg-indigo-600', isSelected);
                    b.classList.toggle('text-white', isSelected);
                    b.classList.toggle('border-indigo-700', isSelected);

                    b.classList.toggle('bg-slate-700', !isSelected);
                    b.classList.toggle('text-slate-300', !isSelected);
                    b.classList.toggle('border-slate-600', !isSelected);
                });
                applyFilterAndSortAndRender();
            });
        });
        
        // Configura√ß√£o para dropdowns MOBILE
        mobileFilterCategory.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            // Desativa a sele√ß√£o do desktop para n√£o haver conflito visual
            filterBtns.forEach(b => {
                b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-700');
                b.classList.add('bg-slate-700', 'text-slate-300', 'border-slate-600');
            });
            applyFilterAndSortAndRender();
        });

        mobileSort.addEventListener('change', (e) => {
            currentSort = e.target.value;
            // Desativa a sele√ß√£o do desktop para n√£o haver conflito visual
            sortBtns.forEach(b => {
                b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-700');
                b.classList.add('bg-slate-700', 'text-slate-300', 'border-slate-600');
            });
            applyFilterAndSortAndRender();
        });
        
        // Listener para o NOVO campo de pesquisa (Busca em tempo real)
        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.trim();
            applyFilterAndSortAndRender();
        });


        // --- L√≥gica de Exporta√ß√£o (CSV) ---

        const convertToCSV = (objArray) => {
            // Definir as chaves que ser√£o usadas como cabe√ßalho
            const header = ['Nome', 'Console', 'Categoria', 'Nota', 'In√≠cio', 'Fim', 'Observa√ß√µes', 'URL da Capa'];
            const dataKeys = ['name', 'console', 'category', 'rating', 'startDate', 'endDate', 'notes', 'coverUrl'];
            
            let csv = header.join(';') + '\n';

            objArray.forEach(row => {
                let line = dataKeys.map(key => {
                    let val = row[key] !== null && row[key] !== undefined ? String(row[key]) : '';
                    // Substitui quebras de linha e pontos e v√≠rgulas para n√£o quebrar o formato CSV
                    val = val.replace(/"/g, '""').replace(/\n/g, ' ').replace(/;/g, ','); 
                    
                    // Adiciona aspas se o valor contiver separadores (v√≠rgula ou ponto e v√≠rgula)
                    if (val.includes(',') || val.includes(';')) {
                        val = `"${val}"`;
                    }
                    return val;
                }).join(';');
                csv += line + '\n';
            });

            return csv;
        };
        
        const exportData = () => {
            if (allGames.length === 0) {
                // Mensagem de erro tempor√°ria no console de carregamento
                showTempMessage("N√£o h√° dados para exportar!", 'red');
                return;
            }

            // Aplicar filtros, ordena√ß√£o e PESQUISA na lista a ser exportada
            let gamesToExport = [...allGames];
            const searchTerm = currentSearchTerm.toLowerCase();

            // 1. Aplica Pesquisa (Igual a applyFilterAndSortAndRender)
            if (searchTerm) {
                gamesToExport = gamesToExport.filter(game => 
                    game.name.toLowerCase().includes(searchTerm) ||
                    game.console.toLowerCase().includes(searchTerm) ||
                    game.category.toLowerCase().includes(searchTerm) ||
                    (game.notes && game.notes.toLowerCase().includes(searchTerm))
                );
            }
            
            // 2. Filtragem
            if (currentFilter !== 'Todos') {
                gamesToExport = gamesToExport.filter(game => game.category === currentFilter);
            }
            
            // 3. Ordena√ß√£o
            gamesToExport.sort((a, b) => {
                if (currentSort === 'ratingDesc') return b.rating - a.rating;
                if (currentSort === 'ratingAsc') return a.rating - b.rating;
                return a.name.localeCompare(b.name);
            });

            if (gamesToExport.length === 0) {
                showTempMessage("Nenhum jogo corresponde aos filtros e pesquisa atuais para exporta√ß√£o.", 'red');
                return;
            }

            const csvContent = convertToCSV(gamesToExport);
            // Cria um Blob para o conte√∫do CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            // Configurar o nome do arquivo e link
            const date = new Date().toISOString().slice(0, 10);
            link.download = `biblioteca_games_export_${date}.csv`;
            link.href = URL.createObjectURL(blob);
            
            // Disparar o download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showTempMessage(`Exporta√ß√£o conclu√≠da! ${gamesToExport.length} jogos exportados.`, 'green');
        };
        
        // Listener para o bot√£o de exporta√ß√£o
        exportBtn.addEventListener('click', exportData);

        // --- L√≥gica de Importa√ß√£o (CSV) ---
        
        const parseCSV = (csvText) => {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const headerLine = lines[0];
            const dataLines = lines.slice(1);

            // Cabe√ßalhos esperados (para valida√ß√£o e mapeamento)
            const expectedHeaders = ['Nome', 'Console', 'Categoria', 'Nota', 'In√≠cio', 'Fim', 'Observa√ß√µes', 'URL da Capa'];
            
            // Chaves internas para mapeamento
            const dataKeys = ['name', 'console', 'category', 'rating', 'startDate', 'endDate', 'notes', 'coverUrl'];

            // Valida√ß√£o simples: verifica se a primeira linha (cabe√ßalhos) cont√©m os campos essenciais.
            const headers = headerLine.split(';'); 
            if (headers.length !== expectedHeaders.length || !headers.every((h, i) => h.trim() === expectedHeaders[i])) {
                throw new Error("Formato de arquivo inv√°lido. O cabe√ßalho do CSV deve corresponder ao formato de exporta√ß√£o.");
            }

            return dataLines.map(line => {
                // Esta √© uma an√°lise de CSV simplificada que assume que o delimitador √© ';' 
                // e que os valores escapados com aspas duplas foram tratados corretamente na exporta√ß√£o/importa√ß√£o.
                const values = line.split(';'); 
                if (values.length !== dataKeys.length) {
                    // Ignora linhas incompletas
                    return null; 
                }

                let game = {};
                values.forEach((v, i) => {
                    let value = v.trim().replace(/^"|"$/g, '').replace(/""/g, '"'); // Remove aspas externas e des-escapa aspas internas
                    const key = dataKeys[i];

                    // Garante o tipo correto para 'rating'
                    if (key === 'rating') {
                        game[key] = parseInt(value) || 0; // Se n√£o for n√∫mero, define como 0
                    } else if (key === 'startDate' || key === 'endDate') {
                        game[key] = value || null;
                    } else {
                        game[key] = value;
                    }
                });
                
                // Adiciona um ID tempor√°rio/novo para a importa√ß√£o (chave do localStorage)
                game.id = Date.now().toString() + Math.random().toString(36).substring(2, 7); 
                
                return game;
            }).filter(game => game !== null);
        };


        const handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!currentUserId) {
                showTempMessage("Opera√ß√£o negada: Modo Local n√£o inicializado.", 'red');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedGames = parseCSV(event.target.result);
                    
                    if (importedGames.length === 0) {
                        showTempMessage("Arquivo importado n√£o cont√©m jogos v√°lidos.", 'red');
                        return;
                    }

                    if (isLocalDevMode) {
                        // MODO LOCAL: Apenas adiciona os jogos √† lista existente
                        allGames.push(...importedGames);
                        saveLocalData();
                        showTempMessage(`Sucesso! ${importedGames.length} jogos importados (salvos localmente).`, 'green');

                    } else {
                        // MODO PROD: Salva cada jogo no Firestore (requer loop ass√≠ncrono)
                        let count = 0;
                        for (const game of importedGames) {
                            try {
                                // Remove o ID tempor√°rio do CSV antes de salvar
                                const { id, ...dataToSave } = game; 
                                await addDoc(getCollectionRef(), { ...dataToSave, timestamp: serverTimestamp() });
                                count++;
                            } catch (err) {
                                console.error(`Falha ao salvar jogo importado ${game.name}:`, err);
                            }
                        }
                        showTempMessage(`Sucesso! ${count} jogos importados para o Firebase.`, 'green');
                    }
                    
                } catch (error) {
                    console.error("Erro durante a importa√ß√£o do CSV:", error);
                    showTempMessage(error.message || "Erro desconhecido ao processar o arquivo.", 'red');
                } finally {
                    // Limpa o input file para que o evento 'change' dispare novamente com o mesmo arquivo
                    e.target.value = null; 
                }
            };
            
            reader.readAsText(file);
        };
        
        importBtn.addEventListener('click', () => {
            importFileInput.click(); // Dispara o clique no input de arquivo oculto
        });
        
        importFileInput.addEventListener('change', handleImport);

        // Fun√ß√£o de Mensagem Tempor√°ria (Substitui o loading-message por um feedback)
        const showTempMessage = (message, type = 'slate') => {
            const messageEl = document.getElementById('loading-message');
            messageEl.classList.remove('hidden', 'text-red-400', 'text-green-400', 'text-slate-400');
            
            switch(type) {
                case 'red':
                    messageEl.classList.add('text-red-400', 'font-bold');
                    break;
                case 'green':
                    messageEl.classList.add('text-green-400', 'font-bold');
                    break;
                default:
                    messageEl.classList.add('text-slate-400');
            }
            messageEl.textContent = message;

            setTimeout(() => {
                messageEl.classList.add('hidden');
                messageEl.classList.remove('font-bold');
            }, 5000);
        }

        // --- Renderiza√ß√£o da Interface (Continua o mesmo) ---

        const createGameCard = (game) => {
            const id = game.id;
            const ratingColor = game.rating >= 8 ? 'bg-green-500' : game.rating >= 5 ? 'bg-yellow-500' : 'bg-red-500';
            const ratingPercent = (game.rating / 10) * 100;
            
            let categoryClasses = 'px-3 py-1 rounded-full text-xs font-semibold';
            switch(game.category) {
                case 'Zerado':
                    categoryClasses += ' bg-green-500 text-green-900';
                    break;
                case 'Jogando':
                    categoryClasses += ' bg-blue-500 text-blue-900';
                    break;
                case 'Desejo Jogar':
                    categoryClasses += ' bg-indigo-500 text-indigo-900';
                    break;
                case 'Abandonado':
                    categoryClasses += ' bg-red-500 text-red-900';
                    break;
                default:
                    categoryClasses += ' bg-slate-500 text-slate-900';
            }

            const coverHtml = game.coverUrl ? 
                `<img src="${game.coverUrl}" 
                      alt="Capa do Jogo ${game.name}" 
                      class="w-20 h-28 object-cover rounded-lg mr-4 flex-shrink-0"
                      onerror="this.onerror=null; this.src='https://placehold.co/80x112/1f2937/d1d5db?text=Sem+Capa';">` : 
                `<div class="w-20 h-28 bg-slate-700 rounded-lg mr-4 flex-shrink-0 flex items-center justify-center text-xs text-slate-500 text-center p-2 leading-tight">Sem Capa</div>`;

            // √çcone do Console
            const consoleIcon = consoleIcons[game.console] || consoleIcons['Outro'];
            
            // Exibi√ß√£o das datas
            const startDateDisplay = game.startDate ? `<span class="font-semibold text-slate-300">${game.startDate}</span>` : 'N/A';
            const endDateDisplay = game.endDate ? `<span class="font-semibold text-slate-300">${game.endDate}</span>` : 'N/A';


            return `
                <div class="game-card bg-slate-800 p-4 rounded-xl flex items-start md:items-center border-l-4 border-indigo-600">
                    
                    ${coverHtml} <!-- Capa/Placeholder -->

                    <!-- Bloco Principal (Texto e Avalia√ß√£o) -->
                    <div class="flex flex-col md:flex-row flex-grow justify-between items-start w-full min-w-0">
                        
                        <!-- Bloco de Texto (Nome, Console, Obs) -->
                        <div class="flex-grow min-w-0 mb-4 md:mb-0 pr-4">
                            <div class="flex items-center space-x-3 mb-1">
                                <span class="${categoryClasses}">${game.category}</span>
                                <h3 class="text-xl font-bold text-white truncate">${game.name}</h3>
                            </div>
                            <p class="text-slate-400 text-sm mb-1">
                                <!-- INSER√á√ÉO DO √çCONE DO CONSOLE AQUI -->
                                <span class="text-lg mr-1 align-middle">${consoleIcon}</span>
                                Console: <span class="font-semibold text-slate-300">${game.console}</span> 
                                | In√≠cio: ${startDateDisplay} 
                                | Fim: ${endDateDisplay}
                            </p>
                            <p class="text-slate-300 text-sm italic overflow-hidden whitespace-nowrap text-ellipsis">Obs: ${game.notes || 'Sem observa√ß√µes.'}</p>
                        </div>
                        
                        <!-- Bloco de Avalia√ß√£o e A√ß√µes -->
                        <div class="flex-shrink-0 w-full md:w-64 space-y-2 md:ml-4">
                            <!-- Visualiza√ß√£o da Nota -->
                            <div class="flex items-center justify-between text-white text-sm font-semibold">
                                <span>Nota:</span>
                                <span class="text-lg text-indigo-400">${game.rating}/10</span>
                            </div>
                            <div class="bg-slate-700 rating-bar w-full">
                                <div class="rating-bar ${ratingColor}" style="width: ${ratingPercent}%;"></div>
                            </div>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="flex space-x-2 pt-2 justify-end">
                                <button data-game='${JSON.stringify(game)}' class="show-details-btn px-3 py-1 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 transition-colors">
                                    Detalhes
                                </button>
                                <button data-id="${id}" data-game='${JSON.stringify(game)}' class="edit-btn px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                                    Editar
                                </button>
                                <button data-id="${id}" data-name="${game.name}" class="delete-btn px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // Adiciona listeners aos bot√µes de Editar, Excluir e DETALHES
        gameList.addEventListener('click', (e) => {
            const target = e.target;
            
            if (target.classList.contains('edit-btn')) {
                const gameData = JSON.parse(target.dataset.game);
                const id = target.dataset.id;
                fillFormForEdit(id, gameData);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            
            } else if (target.classList.contains('delete-btn')) {
                const id = target.dataset.id;
                const name = target.dataset.name;
                openDeleteModal(id, name);
            } else if (target.classList.contains('show-details-btn')) {
                // NOVO: Abre o modal de detalhes
                const gameData = JSON.parse(target.dataset.game);
                openDetailsModal(gameData);
            }
        });
        
        const fillFormForEdit = (id, game) => {
            gameIdInput.value = id;
            nameInput.value = game.name;
            consoleInput.value = game.console;
            categoryInput.value = game.category;
            ratingInput.value = game.rating;
            ratingValueDisplay.textContent = game.rating;
            notesInput.value = game.notes;
            coverUrlInput.value = game.coverUrl || '';
            startDateInput.value = game.startDate || ''; 
            endDateInput.value = game.endDate || ''; 

            formTitle.textContent = 'Editar Jogo: ' + game.name;
            saveBtn.textContent = 'Salvar Edi√ß√£o';
            cancelEditBtn.classList.remove('hidden');
        };

        const resetForm = () => {
            gameForm.reset();
            gameIdInput.value = '';
            formTitle.textContent = 'Adicionar Novo Jogo';
            saveBtn.textContent = 'Salvar Jogo';
            ratingInput.value = 5;
            ratingValueDisplay.textContent = 5;
            cancelEditBtn.classList.add('hidden');
            searchTip.textContent = "Use o bot√£o de busca para pesquisar a capa no Google. Copie o endere√ßo da imagem e cole acima.";
        };

        cancelEditBtn.addEventListener('click', resetForm);

        // --- CRUD: DELETE (Modal Customizado) ---

        let gameToDeleteId = null;

        const openDeleteModal = (id, name) => {
            gameToDeleteId = id;
            modalGameName.textContent = name;
            deleteModal.classList.remove('hidden');
        };

        const closeDeleteModal = () => {
            gameToDeleteId = null;
            deleteModal.classList.add('hidden');
        };

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);

        confirmDeleteBtn.addEventListener('click', async () => {
            if (gameToDeleteId && currentUserId) {
                try {
                    if (isLocalDevMode) {
                        // MODO LOCAL
                        allGames = allGames.filter(game => game.id !== gameToDeleteId);
                        saveLocalData();
                        showTempMessage("Jogo exclu√≠do localmente com sucesso!", 'green');

                    } else {
                        // MODO PROD
                        const collectionRef = getCollectionRef();
                        const gameRef = doc(collectionRef, gameToDeleteId);
                        await deleteDoc(gameRef);
                        showTempMessage("Jogo exclu√≠do do Firebase com sucesso!", 'green');
                    }
                    
                    closeDeleteModal();
                    if (gameIdInput.value === gameToDeleteId) {
                        resetForm();
                    }
                } catch (error) {
                    console.error("Erro ao excluir o jogo:", error);
                    showTempMessage(`Erro ao excluir o jogo: ${error.message}`, 'red');
                }
            }
        });
        
        // --- Fun√ß√µes do Modal de Detalhes ---
        
        const openDetailsModal = (game) => {
            modalDetailsTitle.textContent = game.name;
            
            const consoleIcon = consoleIcons[game.console] || consoleIcons['Outro'];
            modalDetailsSubtitle.innerHTML = `
                <span class="text-lg mr-1 align-middle">${consoleIcon}</span>
                ${game.console}
            `;
            
            // Formatando a cor da nota
            const ratingColor = game.rating >= 8 ? 'text-green-400' : game.rating >= 5 ? 'text-yellow-400' : 'text-red-400';
            
            modalDetailsCategory.textContent = game.category;
            modalDetailsRating.innerHTML = `<span class="${ratingColor}">${game.rating}/10</span>`;
            modalDetailsStartDate.textContent = game.startDate || 'N√£o registrado';
            modalDetailsEndDate.textContent = game.endDate || 'N√£o registrado';
            
            // Usamos textContent e pre-wrap no CSS para formatar as observa√ß√µes longas
            modalDetailsNotes.textContent = game.notes || 'Nenhuma observa√ß√£o detalhada registrada.';
            
            detailsModal.classList.remove('hidden');
        };

        const closeDetailsModal = () => {
            detailsModal.classList.add('hidden');
        };
        
        // Listener para fechar o modal ao clicar no bot√£o 'X' ou fora do conte√∫do
        closeDetailsBtn.addEventListener('click', closeDetailsModal);
        detailsModal.addEventListener('click', (e) => {
            if (e.target === detailsModal) closeDetailsModal();
        });


        // --- Inicializa√ß√£o ---
        initializeAppMode();
    </script>
</body>
</html>